<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cards Against Reality — Pack Design Studio</title>
  <style>
    :root{--bg:#0f0f13;--panel:#1a1b26;--muted:#9ca1b3;--text:#f7f8ff;--acc:#7c5cff;--good:#1ec987;--warn:#ffb020;--bad:#ff6b6b}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text)}
    .wrap{max-width:1180px;margin:0 auto;padding:20px}.panel{background:var(--panel);border:1px solid #ffffff1a;border-radius:14px;padding:16px;margin-bottom:12px}
    .muted{color:var(--muted);font-size:13px} h1,h2,h3{margin:.2rem 0 .6rem}
    .grid{display:grid;gap:10px}.g2{grid-template-columns:1fr}.g3{grid-template-columns:1fr}
    @media(min-width:900px){.g2{grid-template-columns:1fr 1fr}.g3{grid-template-columns:repeat(3,1fr)}}
    input,select,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid #ffffff22;background:#12131c;color:var(--text)}
    textarea{min-height:80px;resize:vertical} button{cursor:pointer} button.primary{background:var(--acc);font-weight:700} button.good{background:var(--good);color:#072514;font-weight:700}
    .row{display:flex;gap:8px;flex-wrap:wrap}.row button{width:auto}
    .step{display:inline-block;padding:4px 8px;border-radius:999px;background:#ffffff12;font-size:12px;margin-right:6px}
    .active{outline:2px solid #7c5cff}.card{padding:10px;border:1px solid #ffffff24;border-radius:10px;background:#11121b}
    .cards{display:grid;grid-template-columns:1fr;gap:8px;max-height:420px;overflow:auto}
    .warn{color:var(--warn)} .bad{color:var(--bad)} .ok{color:var(--good)}
    .price-best{outline:2px solid var(--good)} .small{font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Cards Against Reality — Pack Design Studio</h1>
  <div class="muted">Flow: <span class="step" id="s1">1 Brief</span><span class="step" id="s2">2 Theme</span><span class="step" id="s3">3 Cards</span><span class="step" id="s4">4 Review</span><span class="step" id="s5">5 Export</span></div>

  <div class="panel" id="libraryPanel">
    <h3>Deck Library (Home)</h3>
    <div class="muted">All saved decks in one place. Load, export PDF/JSON, and capture sale intent from here.</div>
    <div class="row" style="margin-top:8px">
      <button id="saveDeck" class="good">Save Current Deck to Library</button>
      <button id="clearDecks">Clear Library</button>
    </div>
    <div id="deckLibrary" class="grid g3" style="margin-top:10px"></div>
  </div>

  <div class="panel" id="step1">
    <h3>1) Brief</h3>
    <div class="grid g2">
      <div><label class="muted">Pack name</label><input id="packName" value="Hank vs Pat Holiday Roast"></div>
      <div><label class="muted">Occasion</label><select id="occasion"><option>Holiday</option><option>Birthday</option><option>Wedding</option><option>Office Party</option></select></div>
      <div><label class="muted">Tone</label><select id="tone"><option>Balanced</option><option>Savage</option><option>Unhinged</option><option>Wholesome</option></select></div>
      <div><label class="muted">Pack size</label><select id="size"><option value="mini">Mini (20+60)</option><option value="standard" selected>Standard (30+90)</option><option value="deluxe">Deluxe (40+120)</option></select></div>
    </div>
    <div style="margin-top:8px"><label class="muted">Lore / inside jokes / people / places</label><textarea id="lore" placeholder="Give me the lore dump..."></textarea></div>
    <div class="row" style="margin-top:10px"><button id="themeBtn" class="primary">Generate Theme Ideas</button><button id="saveDraft">Save Draft</button></div>
  </div>

  <div class="panel" id="step2">
    <h3>2) Theme</h3><div class="muted">Pick one theme direction.</div>
    <div id="themes" class="grid g3" style="margin-top:8px"></div>
  </div>

  <div class="panel" id="step3">
    <h3>3) Cards</h3>
    <div class="row"><button id="genCards" class="primary">Generate Pack Cards</button><button id="regenBlack">Regenerate Black</button><button id="regenWhite">Regenerate White</button></div>
    <div id="stats" class="muted" style="margin-top:8px">No cards generated yet.</div>
    <div id="quality" class="muted"></div>
    <div class="grid g2" style="margin-top:10px">
      <div class="panel"><h3>Prompt Cards (Black)</h3><div id="blackCards" class="cards"></div></div>
      <div class="panel"><h3>Response Cards (White)</h3><div id="whiteCards" class="cards"></div></div>
    </div>
  </div>

  <div class="panel" id="editorPanel">
    <h3>4) Review + Edit</h3>
    <div id="editingMeta" class="muted">Select a card above to edit.</div>
    <textarea id="editingText"></textarea>
    <div class="row" style="margin-top:8px"><button id="rewriteFunny">Rewrite Funnier</button><button id="rewriteSavage">Make Savage</button><button id="rewriteSoft">Soften</button><button id="rewriteShort">Shorten</button><button id="saveEdit" class="good">Save</button></div>
  </div>

  <div class="panel" id="step5">
    <h3>Pricing + Export</h3>
    <div class="grid g3" id="pricing"></div>
    <div class="row" style="margin-top:10px"><input id="buyerEmail" placeholder="Email for purchase intent / delivery list" style="max-width:360px"><button id="buyBtn" class="primary">Select package above</button></div>
    <div id="buyStatus" class="muted" style="margin-top:8px"></div>
    <hr style="border-color:#ffffff1a; margin:14px 0;">
    <div class="row"><button id="exportJson">Download JSON</button><button id="exportPrint" class="primary">Open Print/PDF View</button><button id="sessionSummary">Download Session Summary</button></div>
  </div>
</div>
<script>
const THEMES=[["Holiday Nuclear","Festive cheer + maximum roast energy"],["Lorekeeper","Deep-cut inside jokes"],["Corporate Snowglobe","Office chaos"],["Chaotic Nostalgia","Memory lane gone wrong"],["Family Dinner Disaster","Wholesome setup, feral outcomes"],["Startup Delusion","Pitch deck & caffeine"]];
const BLACK=["At this party, someone brought ____.","The gift reveal was perfect until ____.","Our lore can be summarized by ____.","This pack was sponsored by ____.","The secret ingredient is ____."];
const WHITE=["an apology drafted by AI","three coffees and one bad decision","a friendship held together by memes","weaponized nostalgia","a suspiciously confident group admin"];
const BAD=["slur","racist","nazi","suicide","kill"];
const $=id=>document.getElementById(id); let selectedTheme=null, selectedPackage=null, editing=null;
let pack={black:[],white:[]}; let events=[]; let exportUnlocked=false;
const track=(name,payload={})=>events.push({name,payload,at:new Date().toISOString()});
const choose=a=>a[Math.floor(Math.random()*a.length)];
const words=s=>(s||"").toLowerCase().split(/[^a-z0-9]+/).filter(x=>x.length>3).slice(0,20);
const counts=()=>{const v=$("size").value;return v==='mini'?{b:20,w:60}:v==='deluxe'?{b:40,w:120}:{b:30,w:90}};
function setStep(n){['s1','s2','s3','s4','s5'].forEach((k,i)=>$(k).classList.toggle('active',i===n-1));}
function currentMeta(){return{packName:$("packName").value,occasion:$("occasion").value,tone:$("tone").value,size:$("size").value,theme:selectedTheme}};

function saveDraft(){ localStorage.setItem('car-studio-draft', JSON.stringify({meta:currentMeta(),lore:$("lore").value,pack,events})); track('draft_saved'); alert('Draft saved locally.'); }
function loadDraft(){ try{ const d=JSON.parse(localStorage.getItem('car-studio-draft')||'null'); if(!d) return; const m=d.meta||{}; $("packName").value=m.packName||''; $("occasion").value=m.occasion||'Holiday'; $("tone").value=m.tone||'Balanced'; $("size").value=m.size||'standard'; $("lore").value=d.lore||''; selectedTheme=m.theme||null; pack=d.pack||{black:[],white:[]}; events=d.events||[]; renderPricing(); renderCards(); runChecks(); }catch{} }

const OWNER_KEY='car-owner-id';
const ownerId=localStorage.getItem(OWNER_KEY)||(`owner-${Math.random().toString(36).slice(2,10)}`);
localStorage.setItem(OWNER_KEY,ownerId);
let cachedDecks=[];

async function apiFetch(path, options={}){
  const res=await fetch(path,{...options,headers:{'Content-Type':'application/json','x-owner-id':ownerId,...(options.headers||{})}});
  if(!res.ok) throw new Error(`API ${res.status}`);
  return res.json();
}
function getDecks(){ return cachedDecks; }
function setDecksLocal(decks){ localStorage.setItem('car-deck-library', JSON.stringify(decks)); cachedDecks=decks; }

async function refreshDecks(){
  try{
    const out=await apiFetch('/api/decks');
    cachedDecks=out.decks||[];
  }catch{
    // fallback to legacy localStorage when backend unavailable
    try{ cachedDecks=JSON.parse(localStorage.getItem('car-deck-library')||'[]'); }catch{ cachedDecks=[]; }
  }
  renderDeckLibrary();
}

async function saveCurrentDeck(){
  if(!pack.black.length) return alert('Generate cards first.');
  const deck={meta:currentMeta(),cards:pack};
  try{
    const out=await apiFetch('/api/decks',{method:'POST',body:JSON.stringify(deck)});
    track('deck_saved',{id:out.deck.id,store:'api'});
  }catch{
    const decks=getDecks();
    const id=Date.now().toString();
    decks.unshift({id,meta:deck.meta,cards:deck.cards,createdAt:new Date().toISOString()});
    setDecksLocal(decks.slice(0,50));
    track('deck_saved',{id,store:'local'});
  }
  await refreshDecks();
}
function loadDeck(id){
  const d=getDecks().find(x=>x.id===id); if(!d) return;
  const m=d.meta||{}; $("packName").value=m.packName||''; $("occasion").value=m.occasion||'Holiday'; $("tone").value=m.tone||'Balanced'; $("size").value=m.size||'standard'; selectedTheme=m.theme||null;
  pack=d.cards||{black:[],white:[]}; exportUnlocked=false; renderPricing(); renderCards(); runChecks(); setStep(3); track('deck_loaded',{id});
}
async function deleteDeck(id){
  try{ await apiFetch(`/api/decks/${id}`,{method:'DELETE'}); }
  catch{ setDecksLocal(getDecks().filter(d=>d.id!==id)); }
  await refreshDecks();
}
function renderDeckLibrary(){
  const host=$("deckLibrary"), decks=getDecks(); host.innerHTML='';
  if(!decks.length){ host.innerHTML="<div class='muted'>No saved decks yet. Save one from your current work.</div>"; return; }
  decks.forEach(d=>{
    const c=document.createElement('div'); c.className='card';
    const name=d.meta?.packName||'Untitled deck'; const theme=d.meta?.theme?.name||'No theme';
    c.innerHTML=`<b>${name}</b><div class='muted small'>${theme} • ${d.cards.black.length} black + ${d.cards.white.length} white</div><div class='muted small'>${new Date(d.createdAt||Date.now()).toLocaleString()}</div><div class='row' style='margin-top:8px'><button data-a='load'>Load</button><button data-a='pdf'>PDF</button><button data-a='json'>JSON</button><button data-a='sale'>Sale</button><button data-a='del'>Delete</button></div>`;
    c.querySelector("[data-a='load']").onclick=()=>loadDeck(d.id);
    c.querySelector("[data-a='pdf']").onclick=()=>exportPrint(d);
    c.querySelector("[data-a='json']").onclick=()=>exportJSON(d);
    c.querySelector("[data-a='sale']").onclick=()=>{loadDeck(d.id); setStep(5); alert('Deck loaded. Use pricing section below to capture sale intent.');};
    c.querySelector("[data-a='del']").onclick=()=>deleteDeck(d.id);
    host.appendChild(c);
  });
}

function renderThemes(){ setStep(2); track('theme_generation_started'); const host=$("themes"); host.innerHTML=''; [...THEMES].sort(()=>Math.random()-.5).slice(0,3).forEach(([name,desc])=>{ const d=document.createElement('div'); d.className='card'; d.innerHTML=`<b>${name}</b><div class='muted small'>${desc}</div><button style='margin-top:8px'>Use theme</button>`; d.querySelector('button').onclick=()=>{selectedTheme={name,desc}; [...host.children].forEach(x=>x.style.outline='none'); d.style.outline='2px solid #7c5cff'; track('theme_selected',{name});}; host.appendChild(d);}); }
async function buildCards(){
  if(!selectedTheme) return alert('Pick a theme first.');
  setStep(3);
  const c=counts();
  exportUnlocked=false;
  try{
    const res=await fetch('/api/generate',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({themeName:selectedTheme.name,lore:$("lore").value,counts:c})
    });
    const out=await res.json();
    if(!res.ok) throw new Error(out.error||'generate_failed');
    pack.black=out.black||[];
    pack.white=out.white||[];
  }catch{
    const lore=words($("lore").value);
    pack.black=Array.from({length:c.b},(_,i)=>`${choose(BLACK)} (${selectedTheme.name} ${i+1}: ${lore.length?choose(lore):'inside-joke'})`);
    pack.white=Array.from({length:c.w},(_,i)=>`${choose(WHITE)} — ${lore.length?choose(lore):'chaos'} #${i+1}`);
  }
  renderCards(); runChecks(); track('cards_generated',c);
}
function regen(type){ if(!selectedTheme) return alert('Pick theme first'); exportUnlocked=false; if(type==='black') return buildCards(); if(type==='white') return buildCards(); }
function renderCards(){ const b=$("blackCards"), w=$("whiteCards"); b.innerHTML=''; w.innerHTML=''; pack.black.forEach((t,i)=>{const d=document.createElement('div'); d.className='card'; d.textContent=`${i+1}. ${t}`; d.onclick=()=>openEdit('black',i); b.appendChild(d)}); pack.white.forEach((t,i)=>{const d=document.createElement('div'); d.className='card'; d.textContent=`${i+1}. ${t}`; d.onclick=()=>openEdit('white',i); w.appendChild(d)}); $("stats").textContent=`${pack.black.length} black + ${pack.white.length} white cards`; }
function openEdit(type,idx){ setStep(4); editing={type,idx}; $("editingMeta").textContent=`Editing ${type.toUpperCase()} #${idx+1}`; $("editingText").value=pack[type][idx]; track('card_edit_opened',editing); }
function xform(mode){ if(!editing) return; let t=$("editingText").value; if(mode==='funny') t += ' (everyone pretended this was normal)'; if(mode==='savage') t=t.replace(/friendship/gi,'friendship held together by mild threats').replace(/chaos/gi,'weaponized chaos'); if(mode==='soft') t=t.replace(/weaponized|threats|kill/gi,'unexpected'); if(mode==='short') t=t.split(' ').slice(0,12).join(' ')+'...'; $("editingText").value=t; track('rewrite_clicked',{mode}); }
function saveEdit(){ if(!editing) return; pack[editing.type][editing.idx]=$("editingText").value.trim(); renderCards(); runChecks(); track('card_saved',editing); }
function runChecks(){ const all=[...pack.black,...pack.white].map(x=>x.toLowerCase()); const dup=all.length-new Set(all).size; const mean=all.filter(t=>BAD.some(b=>t.includes(b))).length; const obscure=all.filter(t=>t.split(' ').length>18).length; const parts=[]; if(dup) parts.push(`<span class='warn'>${dup} duplicate-like</span>`); if(mean) parts.push(`<span class='bad'>${mean} too-mean flags</span>`); if(obscure) parts.push(`<span class='warn'>${obscure} too-obscure/long</span>`); if(!parts.length) parts.push(`<span class='ok'>Quality clean ✅</span>`); $("quality").innerHTML=parts.join(' • '); track('quality_checked',{dup,mean,obscure}); }
function renderPricing(){ const s=$("size").value; const base=s==='mini'?14:s==='deluxe'?39:24; const options=[{id:'one',name:'1 Pack',price:base,desc:'Single gift'},{id:'three',name:'3-Pack',price:Math.round(base*3*0.85),desc:'~15% off',best:true},{id:'five',name:'5-Pack',price:Math.round(base*5*0.75),desc:'~25% off'}]; const host=$("pricing"); host.innerHTML=''; options.forEach(o=>{ const d=document.createElement('div'); d.className='card'+(o.best?' price-best':''); d.innerHTML=`<b>${o.name}</b><h2 style='margin:.2rem 0'>$${o.price}</h2><div class='muted small'>${o.desc}${o.best?' • best value':''}</div><button style='margin-top:8px'>Choose</button>`; d.querySelector('button').onclick=()=>{selectedPackage=o; [...host.children].forEach(x=>x.style.outline='none'); d.style.outline='2px solid #1ec987'; $("buyBtn").textContent=`Capture intent: ${o.name} ($${o.price})`; track('package_selected',o);}; host.appendChild(d);}); }
async function captureIntent(){
  if(!selectedPackage) return alert('Select package first');
  const email=$("buyerEmail").value.trim();
  if(!email.includes('@')) return alert('Enter valid email first');

  track('purchase_intent',{email,package:selectedPackage.id,price:selectedPackage.price});
  $("buyStatus").innerHTML=`Creating checkout for <b>${selectedPackage.name}</b>...`;

  try{
    const res=await fetch('/api/checkout/session',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        packageId:selectedPackage.id,
        packageName:selectedPackage.name,
        amountUsd:selectedPackage.price,
        email
      })
    });
    const out=await res.json();
    if(!res.ok) throw new Error(out.error||'checkout_failed');
    if(out.url){ window.location.href=out.url; return; }
    throw new Error('missing_checkout_url');
  }catch(e){
    $("buyStatus").innerHTML=`Captured intent for <b>${selectedPackage.name}</b> at <b>$${selectedPackage.price}</b> from <b>${email}</b>. Stripe checkout not live yet.`;
  }
}

function exportJSON(deck){
  if(!exportUnlocked) return alert('Payment required before export. Complete checkout first.');
  const source = deck ? {meta:deck.meta,cards:deck.cards} : {meta:currentMeta(),cards:pack};
  if(!source.cards.black.length) return alert('Generate cards first');
  setStep(5);
  const payload={meta:source.meta,cards:source.cards,events,ts:new Date().toISOString()};
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}));
  a.download=`${(source.meta.packName||'car-pack').replace(/\s+/g,'-').toLowerCase()}.json`; a.click(); track('export_json');
}
function exportPrint(deck){
  if(!exportUnlocked) return alert('Payment required before export. Complete checkout first.');
  const source = deck ? {meta:deck.meta,cards:deck.cards} : {meta:currentMeta(),cards:pack};
  if(!source.cards.black.length) return alert('Generate cards first');
  setStep(5);
  const esc=s=>(s||'').replace(/</g,'&lt;'); const card=(t,c)=>`<div class='card ${c}'>${esc(t)}</div>`; const w=window.open('','_blank');
  w.document.write(`<!doctype html><html><head><title>Print Pack</title><style>body{font-family:Arial;padding:18px}h1,h2{margin:12px 0 8px}.cover{padding:16px;border:2px dashed #666;margin-bottom:10px}.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}.card{border:1px solid #bbb;min-height:92px;padding:8px;font-size:12px;position:relative}.card:after{content:'';position:absolute;inset:3px;border:1px dotted #ddd}.black{background:#111;color:#fff}.white{background:#fff;color:#111}@media print{.card{min-height:96px}}</style></head><body><div class='cover'><h1>${esc(source.meta.packName)}</h1><div>${esc(source.meta.occasion)} • ${esc(source.meta.tone)} • Theme: ${esc(source.meta.theme?.name||'N/A')}</div><p>Gift-ready custom pack by Cards Against Reality.</p></div><h2>Prompt Cards (Black)</h2><div class='grid'>${source.cards.black.map(x=>card(x,'black')).join('')}</div><h2>Response Cards (White)</h2><div class='grid'>${source.cards.white.map(x=>card(x,'white')).join('')}</div><script>window.onload=()=>window.print()<\/script></body></html>`);
  w.document.close(); track('export_print');
}
function exportSession(){ const sum={eventsCount:events.length,last10:events.slice(-10),funnel:{themeSelected:events.some(e=>e.name==='theme_selected'),cardsGenerated:events.some(e=>e.name==='cards_generated'),intentCaptured:events.some(e=>e.name==='purchase_intent')},ts:new Date().toISOString()}; const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(sum,null,2)],{type:'application/json'})); a.download='car-session-summary.json'; a.click(); }

$("themeBtn").onclick=renderThemes; $("genCards").onclick=buildCards; $("regenBlack").onclick=()=>regen('black'); $("regenWhite").onclick=()=>regen('white');
$("rewriteFunny").onclick=()=>xform('funny'); $("rewriteSavage").onclick=()=>xform('savage'); $("rewriteSoft").onclick=()=>xform('soft'); $("rewriteShort").onclick=()=>xform('short');
$("saveEdit").onclick=saveEdit; $("exportJson").onclick=()=>exportJSON(); $("exportPrint").onclick=()=>exportPrint(); $("sessionSummary").onclick=exportSession; $("size").onchange=renderPricing; $("buyBtn").onclick=captureIntent; $("saveDraft").onclick=saveDraft;
$("saveDeck").onclick=saveCurrentDeck; $("clearDecks").onclick=async ()=>{
  if(!confirm('Delete all saved decks?')) return;
  const decks=[...getDecks()];
  for(const d of decks){
    try{ await apiFetch(`/api/decks/${d.id}`,{method:'DELETE'}); }catch{}
  }
  localStorage.removeItem('car-deck-library');
  cachedDecks=[];
  renderDeckLibrary();
};

const q=new URLSearchParams(window.location.search);
if(q.get('checkout')==='cancelled') $("buyStatus").innerHTML="<span class='warn'>Checkout cancelled.</span>";

async function verifyCheckoutIfNeeded(){
  if(q.get('checkout')!=='success') return;
  const sessionId=q.get('session_id');
  if(!sessionId){ $("buyStatus").innerHTML="<span class='warn'>Payment return missing session id.</span>"; return; }
  try{
    const res=await fetch(`/api/checkout/verify?session_id=${encodeURIComponent(sessionId)}`);
    const out=await res.json();
    if(!res.ok || !out.paid) throw new Error('not_paid');
    exportUnlocked=true;
    $("buyStatus").innerHTML="<span class='ok'>Payment successful ✅ Export unlocked for this session.</span>";
  }catch{
    $("buyStatus").innerHTML="<span class='warn'>Could not verify payment yet.</span>";
  }
}

renderThemes(); renderPricing(); loadDraft(); refreshDecks(); setStep(1); verifyCheckoutIfNeeded();
</script>
</body>
</html>